// ============================================
// Main.silq - Silq å®éªŒå…¥å£ç¨‹åº
// ============================================
// åŒ…å«åŸºç¡€ç¤ºä¾‹éªŒè¯å’Œæµ‹è¯•

// ============================================
// åŸºç¡€ç¤ºä¾‹ 1: Bell æ€åˆ¶å¤‡
// ============================================

def prepareBellState_example(): ğ”¹ Ã— ğ”¹ {
    // åˆå§‹åŒ–ä¸¤ä¸ªé‡å­æ¯”ç‰¹
    var q1 := false: ğ”¹;
    var q2 := false: ğ”¹;
    
    // åº”ç”¨ Hadamard é—¨åˆ°ç¬¬ä¸€ä¸ªé‡å­æ¯”ç‰¹
    q1 := H(q1);
    
    // åº”ç”¨ CNOT é—¨
    q2 := CNOT(q1, q2);
    
    return (q1, q2);
}

// æµ‹é‡ Bell æ€
def measureBellState(): !ğ”¹ Ã— !ğ”¹ {
    let (q1, q2) := prepareBellState_example();
    let m1 := measure(q1);
    let m2 := measure(q2);
    return (m1, m2);
}

// ============================================
// åŸºç¡€ç¤ºä¾‹ 2: é‡å­éšå½¢ä¼ æ€
// ============================================

def quantumTeleportation[stateToTeleport: ğ”¹](): !ğ”¹ {
    // Alice æƒ³è¦ä¼ è¾“çš„é‡å­æ€ (stateToTeleport)
    
    // æ­¥éª¤ 1: åˆ¶å¤‡å…±äº«çš„ Bell æ€
    var aliceBell := false: ğ”¹;
    var bobBell := false: ğ”¹;
    aliceBell := H(aliceBell);
    bobBell := CNOT(aliceBell, bobBell);
    
    // æ­¥éª¤ 2: Alice å¯¹å¥¹çš„ä¸¤ä¸ªé‡å­æ¯”ç‰¹è¿›è¡Œ Bell æµ‹é‡
    // CNOT(state, aliceBell)
    aliceBell := CNOT(stateToTeleport, aliceBell);
    
    // H(state)
    stateToTeleport := H(stateToTeleport);
    
    // æµ‹é‡
    let measurement1 := measure(stateToTeleport);
    let measurement2 := measure(aliceBell);
    
    // æ­¥éª¤ 3: Bob æ ¹æ®æµ‹é‡ç»“æœè¿›è¡Œæ ¡æ­£
    if measurement2 {
        bobBell := X(bobBell);
    }
    if measurement1 {
        bobBell := Z(bobBell);
    }
    
    // Bob çš„é‡å­æ¯”ç‰¹ç°åœ¨æ˜¯åŸå§‹æ€
    return measure(bobBell);
}

// å®Œæ•´çš„éšå½¢ä¼ æ€æµ‹è¯•
def testTeleportation[inputBit: !ğ”¹](): !ğ”¹ {
    // å°†ç»å…¸æ¯”ç‰¹è½¬æ¢ä¸ºé‡å­æ€
    var quantumState := inputBit as ğ”¹;
    
    // æ‰§è¡Œéšå½¢ä¼ æ€
    let result := quantumTeleportation(quantumState);
    
    return result;
}

// ============================================
// åŸºç¡€ç¤ºä¾‹ 3: Grover æœç´¢ç®—æ³•
// ============================================

// Oracle: æ ‡è®°ç›®æ ‡çŠ¶æ€ (å‡è®¾ç›®æ ‡æ˜¯ |11âŸ©)
def groverOracle[q1: ğ”¹, q2: ğ”¹](): ğ”¹ Ã— ğ”¹ {
    // å¯¹äºç›®æ ‡ |11âŸ©ï¼Œåº”ç”¨ç›¸ä½ç¿»è½¬
    // ä½¿ç”¨å¤šæ§åˆ¶ Z é—¨ (ç®€åŒ–ä¸º CNOT + å•é‡å­æ¯”ç‰¹é—¨)
    var q1_temp := q1;
    var q2_temp := q2;
    
    // ç®€åŒ–å®ç°ï¼šå¦‚æœä¸¤ä¸ªéƒ½æ˜¯ 1ï¼Œåˆ™ç¿»è½¬ç›¸ä½
    q1_temp := CNOT(q2_temp, q1_temp);
    q1_temp := Z(q1_temp);
    q1_temp := CNOT(q2_temp, q1_temp);
    
    return (q1_temp, q2_temp);
}

// æ‰©æ•£ç®—å­ (Grover æ‰©æ•£)
def groverDiffusion[q1: ğ”¹, q2: ğ”¹](): ğ”¹ Ã— ğ”¹ {
    var r1 := q1;
    var r2 := q2;
    
    // åº”ç”¨ H åˆ°æ‰€æœ‰é‡å­æ¯”ç‰¹
    r1 := H(r1);
    r2 := H(r2);
    
    // åº”ç”¨ X åˆ°æ‰€æœ‰é‡å­æ¯”ç‰¹
    r1 := X(r1);
    r2 := X(r2);
    
    // åº”ç”¨å¤šæ§åˆ¶ Z (ç®€åŒ–)
    r1 := CNOT(r2, r1);
    r1 := Z(r1);
    r1 := CNOT(r2, r1);
    
    // åº”ç”¨ X åˆ°æ‰€æœ‰é‡å­æ¯”ç‰¹
    r1 := X(r1);
    r2 := X(r2);
    
    // åº”ç”¨ H åˆ°æ‰€æœ‰é‡å­æ¯”ç‰¹
    r1 := H(r1);
    r2 := H(r2);
    
    return (r1, r2);
}

// å®Œæ•´çš„ Grover æœç´¢
def groverSearch(): !ğ”¹ Ã— !ğ”¹ {
    // åˆå§‹åŒ–é‡å­æ¯”ç‰¹
    var q1 := false: ğ”¹;
    var q2 := false: ğ”¹;
    
    // æ­¥éª¤ 1: åˆ›å»ºå‡åŒ€å åŠ 
    q1 := H(q1);
    q2 := H(q2);
    
    // æ­¥éª¤ 2: åº”ç”¨ Grover è¿­ä»£ (å¯¹äº 2 é‡å­æ¯”ç‰¹ï¼Œ1 æ¬¡è¿­ä»£è¶³å¤Ÿ)
    // Oracle
    let (o1, o2) := groverOracle(q1, q2);
    q1 := o1;
    q2 := o2;
    
    // æ‰©æ•£ç®—å­
    let (d1, d2) := groverDiffusion(q1, q2);
    q1 := d1;
    q2 := d2;
    
    // æ­¥éª¤ 3: æµ‹é‡
    let m1 := measure(q1);
    let m2 := measure(q2);
    
    return (m1, m2);
}

// ============================================
// åŸºç¡€ç¤ºä¾‹ 4: Deutsch-Jozsa ç®—æ³•
// ============================================

// å¸¸é‡å‡½æ•° Oracle (f(x) = 0)
def constantZeroOracle[x: ğ”¹](): ğ”¹ {
    return x;
}

// å¸¸é‡å‡½æ•° Oracle (f(x) = 1)
def constantOneOracle[x: ğ”¹](): ğ”¹ {
    return X(x);
}

// å¹³è¡¡å‡½æ•° Oracle (f(x) = x)
def balancedOracle[x: ğ”¹](): ğ”¹ {
    return x;
}

// Deutsch-Jozsa ç®—æ³•
def deutschJozsa[oracle: lifted](): !ğ”¹ {
    // åˆå§‹åŒ–
    var inputQubit := false: ğ”¹;
    var outputQubit := true: ğ”¹;  // |1âŸ©
    
    // åˆ›å»ºå åŠ æ€
    inputQubit := H(inputQubit);
    outputQubit := H(outputQubit);
    
    // åº”ç”¨ Oracle
    outputQubit := oracle(inputQubit, outputQubit);
    
    // æµ‹é‡è¾“å…¥é‡å­æ¯”ç‰¹
    inputQubit := H(inputQubit);
    let result := measure(inputQubit);
    
    // å¦‚æœç»“æœæ˜¯ 0ï¼Œå‡½æ•°æ˜¯å¸¸é‡ï¼›å¦åˆ™æ˜¯å¹³è¡¡çš„
    return result;
}

// ============================================
// èµ„æºæ± å’Œè°ƒåº¦å™¨æµ‹è¯•
// ============================================

def testQubitPool(): !ğŸ™ {
    // åˆ›å»ºèµ„æºæ± é…ç½®
    let config := PoolConfig(
        poolSize: 10,
        maxOperationsPerQubit: 100,
        enableTracking: true
    );
    
    // åˆ›å»ºèµ„æºæ± 
    let pool := createQubitPool(10, config);
    
    // åˆ†é… Qubit
    let (q1, pool1) := allocateQubit(pool);
    
    // è®°å½•æ“ä½œ
    let pool2 := recordOperation(pool1, q1);
    let pool3 := recordOperation(pool2, q1);
    
    // é‡Šæ”¾ Qubit
    let pool4 := releaseQubit(pool3, q1);
    
    // è·å–ç»Ÿè®¡
    let stats := getPoolStats(pool4);
    
    print("=== Qubit Pool Test ===");
    print($"Allocated: {stats.allocatedQubits}");
    print($"Available: {stats.availableQubits}");
    print($"Total Ops: {stats.totalOperations}");
    
    return ();
}

def testTaskQueue(): !ğŸ™ {
    // åˆ›å»ºé˜Ÿåˆ—é…ç½®
    let config := QueueConfig(
        maxQueueSize: 100,
        maxConcurrentTasks: 5,
        defaultPriority: TaskPriority.Normal
    );
    
    // åˆ›å»ºé˜Ÿåˆ—
    let queue := createTaskQueue(config);
    
    // æ·»åŠ ä»»åŠ¡
    let (taskId1, queue1) := createTask(
        queue,
        TaskType.GateOperation,
        [0, 1],
        [0.5],
        TaskPriority.High
    );
    
    let (taskId2, queue2) := createTask(
        queue1,
        TaskType.Measurement,
        [2],
        [],
        TaskPriority.Normal
    );
    
    // å¼€å§‹ä»»åŠ¡
    let queue3 := startTask(queue2, taskId1);
    
    // å®Œæˆä»»åŠ¡
    let queue4 := completeTask(queue3, taskId1, true);
    
    // è·å–ç»Ÿè®¡
    let stats := getQueueStats(queue4);
    
    print("=== Task Queue Test ===");
    print($"Total: {stats.totalTasks}");
    print($"Completed: {stats.completedTasks}");
    print($"Success Rate: {stats.successRate}");
    
    return ();
}

// ============================================
// ç”µè·¯ IR æµ‹è¯•
// ============================================

def testCircuitIR(): !ğŸ™ {
    // åˆ›å»ºç”µè·¯å—
    let block := createCircuitBlock([true, false], 2); // "H" é—¨
    
    // æ·»åŠ  Hadamard é—¨
    let hGate := createSingleQubitGate([true, false], 0, []);
    let hInstr := createInstruction(hGate, [0], [], []);
    let block1 := addInstruction(block, hInstr);
    
    // æ·»åŠ  CNOT é—¨
    let cnotGate := createTwoQubitGate([true, true], 0, 1);
    let cnotInstr := createInstruction(cnotGate, [1], [0], []);
    let block2 := addInstruction(block1, cnotInstr);
    
    // æ‰“å°ä¿¡æ¯
    printCircuitInfo(block2);
    
    return ();
}

// ============================================
// ä¸»å‡½æ•°
// ============================================

def main(): !ğŸ™ {
    print("=== Silq Experiments ===");
    print("");
    
    // æµ‹è¯• Bell æ€
    print("--- Bell State Test ---");
    let (m1, m2) := measureBellState();
    print($"Bell measurement: ({m1}, {m2})");
    print("");
    
    // æµ‹è¯•éšå½¢ä¼ æ€
    print("--- Quantum Teleportation Test ---");
    let teleResult0 := testTeleportation(false);
    let teleResult1 := testTeleportation(true);
    print($"Teleport |0âŸ©: {teleResult0}");
    print($"Teleport |1âŸ©: {teleResult1}");
    print("");
    
    // æµ‹è¯• Grover æœç´¢
    print("--- Grover Search Test ---");
    let (g1, g2) := groverSearch();
    print($"Grover result: ({g1}, {g2})");
    print("(Expected: (1, 1) for target |11âŸ©)");
    print("");
    
    // æµ‹è¯•èµ„æºæ± 
    print("--- Resource Pool Test ---");
    testQubitPool();
    print("");
    
    // æµ‹è¯•ä»»åŠ¡é˜Ÿåˆ—
    print("--- Task Queue Test ---");
    testTaskQueue();
    print("");
    
    // æµ‹è¯•ç”µè·¯ IR
    print("--- Circuit IR Test ---");
    testCircuitIR();
    print("");
    
    print("=== All Tests Complete ===");
    
    return ();
}
